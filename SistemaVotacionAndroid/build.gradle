import org.ajoberstar.gradle.git.tasks.*

buildscript {
  repositories { mavenCentral() }
  dependencies { classpath 'org.ajoberstar:gradle-git:0.2.3' }
}


task antDebugInstall << {
	ProcessBuilder pb = new ProcessBuilder("ant", "debug", "install");
	pb.directory(projectDir);
	Process proc = pb.start();
	proc.consumeProcessErrorStream(System.err)
	proc.consumeProcessOutputStream(System.out)
	if (proc.waitFor() != 0) {
		throw new RuntimeException('antDebugInstall failed')
	}
}

task release <<  {
	ProcessBuilder pb = new ProcessBuilder("ant", "release");
	pb.directory(projectDir);
	Process proc = pb.start();
	proc.consumeProcessErrorStream(System.err)
	proc.consumeProcessOutputStream(System.out)
	if (proc.waitFor() != 0) {
		throw new RuntimeException('release failed')
	}
}

task cloneActionBarSherlockGitRepo(type: GitClone) {
        def destination = file("../ActionBarSherlock")
        uri = "https://github.com/JakeWharton/ActionBarSherlock.git"
        destinationPath = destination
        bare = false
        enabled = !destination.exists() //to clone only once
}

task setActionBarSherlockEnv << {
	def actionBarSherlockLibBuild = file("../ActionBarSherlock/library/build.xml")
	if(actionBarSherlockLibBuild.exists()) return
	ProcessBuilder pb = new ProcessBuilder("android", "update", "project", "-p", ".");
	pb.directory(file("../ActionBarSherlock/library"));
	Process proc = pb.start();
	proc.consumeProcessErrorStream(System.err)
	proc.consumeProcessOutputStream(System.out)
	if (proc.waitFor() != 0) {
		throw new RuntimeException('antDebugInstall failed')
	}
}

task checkDependencies(dependsOn:
	['setAndroidEnv', 'setActionBarSherlockEnv']) << {}

task setAndroidEnv << {
	def env = System.getenv()
	//env.each{println it} 
	String androidHome= env['ANDROID_HOME']
	if(!androidHome) {
		throw new RuntimeException(
			'You must install the android sdk -> http://developer.android.com/sdk/index.html')
	}
	println "androidHome: ${androidHome}"
	ant.replace(file:"local.properties", 
                token:"[sdk.dir]", 
                value:androidHome) 
}


setActionBarSherlockEnv.dependsOn cloneActionBarSherlockGitRepo
release.dependsOn checkDependencies
