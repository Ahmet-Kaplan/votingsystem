import java.net.*;
import org.ajoberstar.gradle.git.tasks.*


apply plugin: 'java'

buildscript {
  repositories { mavenCentral() }
  dependencies { classpath 'org.ajoberstar:gradle-git:0.2.3' }
}

dependencies {
	archives ('org.apache.httpcomponents:httpmime:4.2.2') {
		exclude module: 'httpcore'
	}
}

task antDebugInstall << {
	ProcessBuilder pb = new ProcessBuilder("ant", "debug", "install");
	pb.directory(projectDir);
	Process proc = pb.start();
	proc.consumeProcessErrorStream(System.err)
	proc.consumeProcessOutputStream(System.out)
	if (proc.waitFor() != 0) {
		throw new RuntimeException('antDebugInstall failed')
	}
}

task cleanAndroid << {
	ProcessBuilder pb = new ProcessBuilder("ant", "clean");
	pb.directory(projectDir);
	Process proc = pb.start();
	proc.consumeProcessErrorStream(System.err)
	proc.consumeProcessOutputStream(System.out)
	if (proc.waitFor() != 0) {
		throw new RuntimeException('antDebugInstall failed')
	}
}

task release <<  {
	ProcessBuilder pb = new ProcessBuilder("ant", "release");
	pb.directory(projectDir);
	Process proc = pb.start();
	proc.consumeProcessErrorStream(System.err)
	proc.consumeProcessOutputStream(System.out)
	if (proc.waitFor() != 0) {
		throw new RuntimeException('release failed')
	}
}

task cloneActionBarSherlockGitRepo(type: GitClone) {
        def destination = file("../ActionBarSherlock")
        uri = "https://github.com/JakeWharton/ActionBarSherlock.git"
        destinationPath = destination
        bare = false
        enabled = !destination.exists() //to clone only once
}

task setActionBarSherlockEnv << {
	def actionBarSherlockLibBuild = file("../ActionBarSherlock/library/build.xml")
	if(actionBarSherlockLibBuild.exists()) return
	ProcessBuilder pb = new ProcessBuilder("android", "update", "project", "-p", ".");
	pb.directory(file("../ActionBarSherlock/library"));
	Process proc = pb.start();
	proc.consumeProcessErrorStream(System.err)
	proc.consumeProcessOutputStream(System.out)
	if (proc.waitFor() != 0) {
		throw new RuntimeException('antDebugInstall failed')
	}
}

task copyToLib(type: Copy) {
	into "libs"
	from project.configurations.archives
}

task checkDependencies(dependsOn:['copyToLib',
	'setAndroidEnv', 'setActionBarSherlockEnv']) << {}

task setAndroidEnv << {
	//def env = System.getenv()
	//env.each{println it} 
	//String androidHome= env['ANDROID_HOME']
	def controlAccesoURL = "$rootProject.controlAccesoProtocol://" + 
		"${getDevelopmentServerIP()}:$rootProject.controlAccesoPort" + 
		"$rootProject.controlAccesoPath";
	println("controlAccesoURL: $controlAccesoURL")
	ant.copy(file:"assets/VotingSystem",
		toFile:"assets/VotingSystem.properties")
	ant.replace(file:"assets/VotingSystem.properties",
		token:"[CONTROL_ACCESO_URL]",
		value:controlAccesoURL)
}


def getDevelopmentServerIP() {
	Enumeration<NetworkInterface> nets = NetworkInterface.getNetworkInterfaces();
	for (NetworkInterface netint : Collections.list(nets)){
		Enumeration<InetAddress> inetAddresses = netint.getInetAddresses();
		for (InetAddress inetAddress : Collections.list(inetAddresses)) {
			if(inetAddress.isSiteLocalAddress()) {
				String inetAddressStr = inetAddress.toString();
				while(inetAddressStr.startsWith("/"))
					inetAddressStr = inetAddressStr.substring(1)
				return inetAddressStr
			}
			
		}
	}
}

setActionBarSherlockEnv.dependsOn cloneActionBarSherlockGitRepo
release.dependsOn checkDependencies
antDebugInstall.dependsOn checkDependencies