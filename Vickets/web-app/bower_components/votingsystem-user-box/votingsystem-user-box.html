<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">
<link rel="import" href="../core-icon/core-icon.html">

<polymer-element name="votingsystem-user-box" attributes="boxCaption multiSelection">
    <template>
        <core-ajax auto handleAs="json" url="./i18n/messages.json" response="{{locales}}"></core-ajax>
        <style>
            .receptorsBox {
                margin: 10px auto 30px auto;
                padding: 5px 0px 0px 0px;;
                border: none;
                width:450px;
            }
            .receptorsBox legend {
                font-size: 1.2em;
                font-weight: bold;
                color:#6c0404;
            }
        </style>
        <div layout vertical style="border: 1px solid #ccc;padding:0px 0px 0px 10px;display:{{ uservsList.length == 0?'none':'block'}}">
            <fieldset class="receptorsBox" id="fieldsBox" style="">
                <legend id="fieldsLegend" style="border: none; margin:5px 0px 0px 0px;">{{boxCaption}}</legend>
                <template repeat="{{uservs in uservsList}}">
                    <div layout horizontal style="padding: 0px 10px 0px 10px;">
                        <core-icon-button icon="close" style="fill:#6c0404;" on-tap="{{removeUser}}"></core-icon-button>
                        <div flex layout vertical center-justified style='font-size:1em;padding:0px 0 0 0px;vertical-align:middle;'>
                            {{(uservs.firstName != null && "" != uservs.firstName) ? uservs.firstName + " " + uservs.lastName:uservs.name}}
                        </div>
                    </div>
                </template>
            </fieldset>
        </div>
    </template>
    <script>
        Polymer('votingsystem-user-box', {
            localesChanged:function() {
                var results = new RegExp("[\\?&]locale=([^&#]*)").exec(location.search);
                var userLocale = ((results == null) ? "" : decodeURIComponent(results[1].replace(/\+/g, " "))) || navigator.language
                if(this.locales[userLocale]) this.messages = this.locales[userLocale]
                else this.messages = this.locales['es']
                console.log(this.tagName + " loaded locales for: " + userLocale)
            },
            ready:function() {
                this.multiSelection = this.multiSelection || true
                this.uservsList = []
            },
            addUser:function(userToAdd) {
                var isNewUser = true
                for(userIdx in this.uservsList) {
                    if(userToAdd.id == this.uservsList[userIdx].id) isNewUser = false
                }
                console.log("votingsystem-user-box - addUser: " + userToAdd.nif + " - isNewUser: " + isNewUser +
                        " - multiSelection: " + this.multiSelection)
                if(isNewUser) {
                    if(!this.multiSelection) this.uservsList = [userToAdd]
                    else this.uservsList.push(userToAdd)
                }
            },
            getUserList:function(userList) {
                return this.uservsList
            },
            removeUser:function(e) {
                var userToDelete = e.target.templateInstance.model.uservs
                for(userIdx in this.uservsList) {
                    if(userToDelete.id == this.uservsList[userIdx].id) {
                        this.uservsList.splice(userIdx, 1)
                    }
                }
            },
            removeUsers:function(e) {
                this.uservsList = []
            }
        });</script>
</polymer-element>
