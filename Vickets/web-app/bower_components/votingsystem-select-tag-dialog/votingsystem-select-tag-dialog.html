<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../votingsystem-button/votingsystem-button.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">
<link rel="import" href="../votingsystem-dialog/votingsystem-dialog.html">


<!--
Dialog to search and select tags

##### Example

    <votingsystem-select-tag-dialog></votingsystem-select-tag-dialog>

@element votingsystem-select-tag-dialog
@blurb Dialog to search and select tags
@status alpha
@homepage http://votingsystem.github.io/votingsystem-select-tag-dialog
-->
<polymer-element name="votingsystem-select-tag-dialog" attributes="caption opened serviceURL">
    <template>
        <votingsystem-dialog id="xDialog" class="dialog" on-core-overlay-open="{{onCoreOverlayOpen}}">
        <link rel="stylesheet" href="votingsystem-select-tag-dialog.css" />
        <core-ajax auto handleAs="json" url="{{urlLocales}}" response="{{locales}}"></core-ajax>
        <core-ajax id="ajax" auto url="{{url}}" response="{{responseData}}" handleAs="json" method="get"
                    contentType="json"></core-ajax>
          <style no-shim>
              .dialog {
                  box-sizing: border-box;
                  -moz-box-sizing: border-box;
                  font-family: Arial, Helvetica, sans-serif;
                  font-size: 13px;
                  -webkit-user-select: none;
                  -moz-user-select: none;
                  overflow: auto;
                  background: white;
                  padding:10px 30px 30px 30px;
                  outline: 1px solid rgba(0,0,0,0.2);
                  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
                  width: 400px;
              }
          </style>
          <div id="container" layout vertical style="max-width: 500px; padding:10px;">
              <div layout horizontal style="padding: 0px 10px 0px 20px;" >
                  <h3 flex style="color: #6c0404; font-weight: bold;">{{caption}}</h3>
                  <core-icon-button icon="close" style="fill:#6c0404;" on-tap="{{close}}"></core-icon-button>
              </div>


              <div layout vertical wrap style="border: 1px solid #ccc; padding:10px; margin:0px 0px 10px 0px;
                display:{{(selectedTagList == null || selectedTagList.length == 0) ? 'none':'block'}}">
                  <div style="font-weight: bold; margin:0px 0px 5px 0px;">{{messages.selectedTagsLbl}}</div>
                  <div flex horizontal wrap layout style="">
                  <template repeat="{{tag in selectedTagList}}">
                      <a class="btn btn-default" on-click="{{removeTag}}" style="font-size: 0.9em; margin:5px 5px 0px 0px;padding:3px;">
                          {{tag.name}} <i class="fa fa-minus"></i></a>
                  </template>
                  </div>
              </div>

              <div flex layout horizontal center center-justified>
                  <paper-input id="tagSearchInput" floatinglabel label="{{messages.tagLbl}}" required autofocus>
                  </paper-input>
                  <votingsystem-button on-click="{{searchTag}}" style="margin: 0px 0px 0px 5px;">
                    {{messages.tagSearchLbl}} <i class="fa fa-search"></i>
                  </votingsystem-button>
              </div>

              <div style="text-align:center; display: {{searchString!= null ? 'block':'none'}}">
                {{messages.searchResultLbl}} <b>'{{searchString}}'</b>
              </div>

              <div flex horizontal wrap layout style="">
                  <template repeat="{{tag in searchedTagList}}">
                      <a class="btn btn-default" on-click="{{selectTag}}" style="font-size: 0.9em; margin:5px 5px 0px 0px;padding:3px;">
                          {{tag.name}} <i class="fa fa-plus"></i></a>
                  </template>
              </div>
              <div layout horizontal style="margin:10px 20px 0px 0px;">
                  <div flex></div>
                  <votingsystem-button on-click="{{processTags}}">
                      {{messages.acceptLbl}} <i class="fa fa-check"></i>
                  </votingsystem-button>
              </div>
          </div>
        </votingsystem-dialog>
    </template>
    <script>
        Polymer('votingsystem-select-tag-dialog', {
            localesChanged:function() {
                var results = new RegExp("[\\?&]locale=([^&#]*)").exec(location.search);
                var userLocale = ((results == null) ? "" : decodeURIComponent(results[1].replace(/\+/g, " "))) || navigator.language
                if(this.locales[userLocale]) this.messages = this.locales[userLocale]
                else this.messages = this.locales['es']
                console.log(this.tagName + " loaded locales for: " + userLocale)
            },
            onCoreOverlayOpen:function(e) {
                this.opened = this.$.xDialog.opened
            },
          /**
           * The `caption` of the dialog
           *
           * @attribute caption
           * @type string
           */
          caption: null,

            isShowingTags: false,
            /**
             * The `maxNumberTags` user can select
             *
             * @attribute maxNumberTags
             * @type number
             */
            maxNumberTags:3,

            /**
             * The `url` of the HTTP tag service
             *
             * @attribute url
             * @type string
             */
            serviceURL: null,

              ready: function() {
                  this.urlLocales = window['serverURL'] + "/bower_components/" + this.tagName.toLowerCase() + "/i18n/messages.json"
                  this.searchString = null
                  this.selectedTagList = []
                  this.searchedTagList =[]
                  var tagdialog = this
                  this.$.tagSearchInput.onkeypress = function(event){
                      var chCode = ('charCode' in event) ? event.charCode : event.keyCode;
                      if (chCode == 13)  tagdialog.searchTag()
                  }
              },

            openedChanged: function() {
                this.$.xDialog.opened = this.opened
                if(this.opened == false) this.close()
                if(!this.opened) {
                    this.$.tagSearchInput.inputValue = ''
                    this.searchedTagList = []
                    this.selectedTagList = []
                    this.$.tagSearchInput.value = ""
                    this.isShowingTags = false
                    this.searchString = null
                    this.$.ajax.url = null
                }
            },

            close:function() {
                this.opened = false;
            },
            /**
             * Toggle the dialog's opened state.
             * @method toggle
             */
            toggle: function() {
                this.opened = !this.opened
            },

            responseDataChanged:function () {
                this.searchedTagList = this.responseData.tagRecords
            },

            searchTag: function() {
                if(!this.$.tagSearchInput.invalid) {
                    this.$.ajax.url = this.serviceURL + "?tag=" + this.$.tagSearchInput.inputValue
                    this.searchString = this.$.tagSearchInput.inputValue
                }

            },

            selectTag: function(e) {
                var selectedTag = e.target.templateInstance.model.tag
                var isNewTag = true
                for(tagIdx in this.selectedTagList) {
                    if(selectedTag.id == this.selectedTagList[tagIdx].id) isNewTag = false
                }
                console.log("selectTag: " + selectedTag.id + " - isNewTag: " + isNewTag + " - maxNumTags: " + this.maxNumTags +
                        " - num. tags selected: " + this.selectedTagList.length)
                if(isNewTag) {
                    if(this.selectedTagList.length == this.maxNumTags ) {
                        this.searchedTagList.push(this.selectedTagList[0])
                        this.selectedTagList.splice(0, 1)
                    }
                    this.selectedTagList.push(selectedTag)
                    for(tagIdx in this.searchedTagList) {
                        if(selectedTag.id == this.searchedTagList[tagIdx].id) this.searchedTagList.splice(tagIdx, 1)
                    }
                }
            },

            removeTag: function(e) {
                var selectedTag = e.target.templateInstance.model.tag
                for(tagIdx in this.selectedTagList) {
                    if(selectedTag.id == this.selectedTagList[tagIdx].id) {
                        this.selectedTagList.splice(tagIdx, 1)
                        this.searchedTagList.push(selectedTag)
                    }
                }
            },

            reset: function() {
                this.selectedTagList = []
                this.searchedTagList = []
            },

            show: function (maxNumberTags, selectedTags) {
                this.opened = true
                this.maxNumTags = maxNumberTags
                if(selectedTags == null) this.selectedTagList = []
                else this.selectedTagList = selectedTags
                this.isShowingTags = true
            },

            processTags: function() {
                this.fire('tag-selected', this.selectedTagList);
                this.opened = false
            }

        });
    </script>
</polymer-element>