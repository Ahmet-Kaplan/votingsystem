<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../votingsystem-button/votingsystem-button.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">

<!--
Dialog to search and select tags

##### Example

    <votingsystem-select-tag-dialog></votingsystem-select-tag-dialog>

@element votingsystem-select-tag-dialog
@blurb Dialog to search and select tags
@status alpha
@homepage http://votingsystem.github.io/votingsystem-select-tag-dialog
-->
<polymer-element name="votingsystem-select-tag-dialog" attributes="caption opened serviceURL">
    <template>
        <link rel="stylesheet" href="votingsystem-select-tag-dialog.css" />
        <core-ajax auto handleAs="json" url="./i18n/messages.json" response="{{locales}}"></core-ajax>
        <core-ajax id="ajax" auto url="{{url}}" response="{{responseData}}" handleAs="json" method="get"
                    contentType="json"></core-ajax>
          <style no-shim>
              .view { :host {position: relative;} }
              .card {
                  position: relative;
                  display: inline-block;
                  vertical-align: top;
                  background-color: #f9f9f9;
                  box-shadow: 0 12px 15px 0 rgba(0, 0, 0, 0.24);
                  border: 1px solid #ccc;
                  width:500px;
              }
              button {
                  background-color: #f9f9f9;
                  color: #6c0404;
                  border: 1px solid #ccc;
                  margin:10px;
              }
          </style>
          <div id="container" class="card" layout vertical style="max-width: 500px; padding:10px;">
              <div layout horizontal style="padding: 0px 10px 0px 20px;" >
                  <h3 flex style="color: #6c0404; font-weight: bold;">{{caption}}</h3>
                  <core-icon-button icon="close" style="fill:#6c0404;" on-tap="{{close}}"></core-icon-button>
              </div>


              <div layout vertical wrap style="border: 1px solid #ccc; padding:10px; margin:0px 0px 10px 0px;
                display:{{(selectedTagList == null || selectedTagList.length == 0) ? 'none':'block'}}">
                  <div style="font-weight: bold; margin:0px 0px 5px 0px;">{{messages.selectedTagsLbl}}</div>
                  <div flex horizontal wrap layout style="">
                  <template repeat="{{tag in selectedTagList}}">
                      <paper-button raisedButton label="{{tag.name}}" class="button" icon="remove-circle"
                                    on-click="{{removeTag}}" style="margin:5px 5px 0px 0px;"></paper-button>
                  </template>
                  </div>
              </div>

              <div flex layout horizontal center center-justified>
                  <paper-input id="tagSearchInput" floatinglabel label="{{messages.tagLbl}}" required autofocus>
                  </paper-input>
                  <votingsystem-button on-click="{{searchTag}}" style="margin: 0px 0px 0px 5px;">
                    {{messages.tagSearchLbl}} <i class="fa fa-search"></i>
                  </votingsystem-button>
              </div>

                <div style="display: {{searchString!= null ? 'block':'none'}}">{{messages.searchResultLbl}} '{{searchString}}'</div>


              <div flex horizontal wrap layout style="">
                  <template repeat="{{tag in searchedTagList}}">
                      <paper-button raisedButton class="button" label="{{tag.name}}" on-click="{{selectTag}}"
                                    icon="add-circle" style="margin:5px 5px 0px 0px;">
                      </paper-button>
                  </template>
              </div>
              <div layout horizontal style="margin:10px 20px 0px 0px;">
                  <div flex></div>
                  <votingsystem-button on-click="{{processTags}}">
                      {{messages.acceptLbl}} <i class="fa fa-check"></i>
                  </votingsystem-button>
              </div>
          </div>
    </template>
    <script>
        Polymer('votingsystem-select-tag-dialog', {
            localesChanged:function() {
                var results = new RegExp("[\\?&]locale=([^&#]*)").exec(location.search);
                var userLocale = ((results == null) ? "" : decodeURIComponent(results[1].replace(/\+/g, " "))) || navigator.language
                if(this.locales[userLocale]) this.messages = this.locales[userLocale]
                else this.messages = this.locales['es']
                console.log(this.tagName + " loaded locales for: " + userLocale)
            },
          /**
           * The `caption` of the dialog
           *
           * @attribute caption
           * @type string
           */
          caption: null,

            isShowingTags: false,
            /**
             * The `maxNumberTags` user can select
             *
             * @attribute maxNumberTags
             * @type number
             */
            maxNumberTags:3,

            /**
             * The `url` of the HTTP tag service
             *
             * @attribute url
             * @type string
             */
            serviceURL: null,

              ready: function() {
                  this.searchString = null
                  this.style.display = 'none'
                  this.selectedTagList = []
                  this.searchedTagList =[]
                  var tagdialog = this
                  this.$.tagSearchInput.onkeypress = function(event){
                      var chCode = ('charCode' in event) ? event.charCode : event.keyCode;
                      if (chCode == 13)  tagdialog.searchTag()
                  }
              },

            openedChanged: function() {
                if(this.opened) {
                    this.style.display = 'block'
                } else {
                    this.style.display = 'none'
                    this.$.tagSearchInput.inputValue = ''
                    this.searchedTagList = []
                    this.selectedTagList = []
                    this.isShowingTags = false
                }
            },

            close:function() {
                this.opened = false;
            },
            /**
             * Toggle the dialog's opened state.
             * @method toggle
             */
            toggle: function() {
                this.opened = !this.opened
            },

            responseDataChanged:function () {
                this.searchedTagList = this.responseData.tagRecords
            },

            searchTag: function() {
                if(!this.$.tagSearchInput.invalid) {
                    this.$.ajax.url = this.serviceURL + "?tag=" + this.$.tagSearchInput.inputValue
                    this.searchString = this.$.tagSearchInput.inputValue
                }

            },

            selectTag: function(e) {
                var selectedTag = e.target.templateInstance.model.tag
                var isNewTag = true
                for(tagIdx in this.selectedTagList) {
                    if(selectedTag.id == this.selectedTagList[tagIdx].id) isNewTag = false
                }
                console.log("selectTag: " + selectedTag.id + " - isNewTag: " + isNewTag + " - maxNumTags: " + this.maxNumTags +
                        " - num. tags selected: " + this.selectedTagList.length)
                if(isNewTag) {
                    if(this.selectedTagList.length == this.maxNumTags ) {
                        this.searchedTagList.push(this.selectedTagList[0])
                        this.selectedTagList.splice(0, 1)
                    }
                    this.selectedTagList.push(selectedTag)
                    for(tagIdx in this.searchedTagList) {
                        if(selectedTag.id == this.searchedTagList[tagIdx].id) this.searchedTagList.splice(tagIdx, 1)
                    }
                }
            },

            removeTag: function(e) {
                var selectedTag = e.target.templateInstance.model.tag
                for(tagIdx in this.selectedTagList) {
                    if(selectedTag.id == this.selectedTagList[tagIdx].id) {
                        this.selectedTagList.splice(tagIdx, 1)
                        this.searchedTagList.push(selectedTag)
                    }
                }
            },

            reset: function() {
                this.selectedTagList = []
                this.searchedTagList = []
            },

            show: function (maxNumberTags, selectedTags) {
                this.opened = true
                this.maxNumTags = maxNumberTags
                if(selectedTags == null) this.selectedTagList = []
                else this.selectedTagList = selectedTags
                this.isShowingTags = true
            },

            /**
            * Fire the selected tags
            *
            * @method processTags
            */
            processTags: function() {
                this.fire('tag-selected', this.selectedTagList);
                this.opened = false
            }

        });
    </script>
</polymer-element>