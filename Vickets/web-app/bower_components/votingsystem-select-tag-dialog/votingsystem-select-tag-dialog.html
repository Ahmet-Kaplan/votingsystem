<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-overlay/core-overlay.html">
<link rel="import" href="../core-ajax/core-ajax.html">
<link rel="import" href="../votingsystem-input/votingsystem-input.html">
<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../core-item/core-item.html">
<link rel="import" href="../paper-button/paper-button.html">


<!--
Dialog to search and select tags

##### Example

    <votingsystem-select-tag-dialog></votingsystem-select-tag-dialog>

@element votingsystem-select-tag-dialog
@blurb Dialog to search and select tags
@status alpha
@homepage http://votingsystem.github.io/votingsystem-select-tag-dialog
-->
<polymer-element name="votingsystem-select-tag-dialog" attributes="caption opened serviceURL">

  <template>
        <link rel="stylesheet" href="votingsystem-select-tag-dialog.css" />
        <core-ajax id="ajax" auto url="{{url}}" response="{{responseData}}" handleAs="json" method="get"
                    contentType="json"></core-ajax>


      <core-overlay flex vertical id="coreOverlay" vertical class="card tag1" opened="{{opened}}" layered="true"
                    style="position: absolute; top:30px;">
          <!-- place all overlay styles inside the overlay target -->
          <style no-shim>
              .card {
                  position: relative;
                  display: inline-block;
                  vertical-align: top;
                  background-color: #f9f9f9;
                  box-shadow: 0 12px 15px 0 rgba(0, 0, 0, 0.24);
                  border: 1px solid #ccc;
              }
              paper-button.button {
                  background-color: #f9f9f9;
                  color: #6c0404;
                  border: 1px solid #ccc;
                  margin:10px;
                  vertical-align: middle;
                  line-height: 24px;
                  height: 35px;
              }
          </style>
          <div layout vertical style="max-width: 450px; padding:10px;">
              <h3>{{caption}}</h3>

              <div layout vertical wrap style="border: 1px solid #ccc; padding:10px; margin:0px 0px 10px 0px;
                display:{{(selectedTagList == null || selectedTagList.length == 0) ? 'none':'block'}}">
                  <div style="font-weight: bold; margin:0px 0px 5px 0px;">{{messages.selectedTagsLbl}}</div>
                  <div flex horizontal wrap layout style="">
                  <template repeat="{{tag in selectedTagList}}">
                      <section>
                          <div class="center button raised" on-click="{{removeTag}}" style="margin:0px 5px 0px 0px;">
                              <div fit>{{tag.name}}
                                <core-icon icon="remove-circle" style="fill:#6c0404; padding:0px 0px 0px 0px;"></core-icon>
                              </div>
                              <paper-ripple fit></paper-ripple>
                          </div>
                      </section>
                  </template>
                  </div>
              </div>

              <div flex layout horizontal center center-justified>
                  <votingsystem-input id="tagSearchInput" floatinglabel label="{{messages.tagLbl}}" required autofocus>
                  </votingsystem-input>
                  <paper-button raisedButton label="{{messages.tagSearchLbl}}" class="button"
                                on-click="{{searchTag}}" style=""></paper-button>
              </div>
              <div flex horizontal wrap layout style="">
                  <template repeat="{{tag in searchedTagList}}">
                      <section style>
                          <div class="center button raised" on-click="{{selectTag}}" style="margin:0px 5px 0px 0px;">
                              <div fit>{{tag.name}}
                                  <core-icon icon="add-circle" style="fill:#6c0404; padding:0px 0px 0px 0px;"></core-icon>
                              </div>
                              <paper-ripple fit></paper-ripple>
                          </div>
                      </section>

                  </template>
              </div>
              <div layout horizontal style="margin:10px 20px 0px 0px;">
                  <div flex></div>
                  <paper-button raisedButton class="button" label="{{messages.acceptLbl}}" on-click="{{fireTags}}" style="">

                  </paper-button>
              </div>
          </div>
      </core-overlay>

      <conten></conten>
  </template>
  <script type="text/javascript" src="./i18n/messages.js"></script>
  <script>

    Polymer('votingsystem-select-tag-dialog', {

      /**
       * The `caption` of the dialog
       *
       * @attribute caption
       * @type string
       */
      caption: null,

        isShowingTags: false,
        /**
         * The `maxNumberTags` user can select
         *
         * @attribute maxNumberTags
         * @type number
         */
        maxNumberTags:3,

        /**
         * The `url` of the HTTP tag service
         *
         * @attribute url
         * @type string
         */
        serviceURL: null,

      ready: function() {
          console.log(this.tagName + " ready - locale: " + userLocale)
          this.messages = localizedMessages
          this.selectedTagList = [],
          this.searchedTagList =[],
          var tagdialog = this
          this.$.tagSearchInput.onkeypress = function(event){
              var chCode = ('charCode' in event) ? event.charCode : event.keyCode;
              if (chCode == 13)  tagdialog.searchTag()
          }
      },

        openedChanged: function() {
            this.$.tagSearchInput.inputValue = ''
            this.searchedTagList = []
            if(!this.isShowingTags) this.selectedTagList = []
            else this.isShowingTags = false
            this.async(function() {this.$.coreOverlay.style.top = "30px" }, null, 1);
        },

        /**
         * Toggle the dialog's opened state.
         * @method toggle
         */
        toggle: function() {
            this.$.coreOverlay.toggle();

        },

        responseDataChanged:function () {
            this.searchedTagList = this.responseData.tagRecords
        },

        searchTag: function() {
            if(!this.$.tagSearchInput.invalid) {
                this.$.ajax.url = this.serviceURL + "?tag=" + this.$.tagSearchInput.inputValue
            }

        },

        selectTag: function(e) {
            var selectedTag = e.target.templateInstance.model.tag
            var isNewTag = true
            for(tagIdx in this.selectedTagList) {
                if(selectedTag.id == this.selectedTagList[tagIdx].id) isNewTag = false
            }
            console.log("selectTag: " + selectedTag.id + " - isNewTag: " + isNewTag + " - maxNumTags: " + this.maxNumTags +
                    " - num. tags selected: " + this.selectedTagList.length)
            if(isNewTag) {
                if(this.selectedTagList.length == this.maxNumTags ) {
                    this.searchedTagList.push(this.selectedTagList[0])
                    this.selectedTagList.splice(0, 1)
                }
                this.selectedTagList.push(selectedTag)
                for(tagIdx in this.searchedTagList) {
                    if(selectedTag.id == this.searchedTagList[tagIdx].id) this.searchedTagList.splice(tagIdx, 1)
                }
            }
        },

        removeTag: function(e) {
            var selectedTag = e.target.templateInstance.model.tag
            for(tagIdx in this.selectedTagList) {
                if(selectedTag.id == this.selectedTagList[tagIdx].id) {
                    this.selectedTagList.splice(tagIdx, 1)
                    this.searchedTagList.push(selectedTag)
                }
            }
        },

        reset: function() {
            this.selectedTagList = []
            this.searchedTagList = []
        },

        show: function (maxNumberTags, selectedTags) {
            this.$.coreOverlay.opened = true
            this.maxNumTags = maxNumberTags
            if(selectedTags == null) this.selectedTagList = []
            else this.selectedTagList = selectedTags
            this.isShowingTags = true
        },

      /**
       * Fire the selected tags
       * 
       * @method fireTags
       */
      fireTags: function() {
            this.fire('tag-selected', this.selectedTagList);
            this.$.coreOverlay.toggle();
      }

    });

  </script>

</polymer-element>
